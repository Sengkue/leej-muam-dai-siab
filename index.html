<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duab Toj Siab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Noto Sans Lao', sans-serif;
            background-color: #f8fafc;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .image-container {
            position: relative;
            overflow: hidden;
            transition: transform 0.5s ease;
        }
        
        .image-container:hover {
            transform: scale(1.02);
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .loader {
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .image-placeholder {
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                    <img src="https://duabhmoobtojsiab.com/logoxs.png" alt="Duab Toj Siab Logo" class="h-12 w-12 mr-3">
                    <div>
                        <h1 class="text-2xl font-bold">Duab Toj Siab</h1>
                        <p class="text-sm opacity-80">ຮູບພາບຊາວເມືອງລາວ</p>
                    </div>
                </div>
                
                <div class="flex space-x-4">
                    <button id="refreshBtn" class="bg-white text-purple-600 px-4 py-2 rounded-lg font-semibold hover:bg-gray-100 transition flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i> ໂຫຼດຂໍ້ມູນໃໝ່
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Stats Section -->
        <div class="mb-8 grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-2xl font-bold text-purple-600" id="totalPosts">0</div>
                <div class="text-gray-600">ຈຳນວນໂພສ</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-2xl font-bold text-blue-600" id="totalViews">0</div>
                <div class="text-gray-600">ຍອດເບິ່ງຮວມ</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-2xl font-bold text-green-600" id="vientianePosts">0</div>
                <div class="text-gray-600">ໃນນະຄອນຫຼວງ</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-2xl font-bold text-orange-600" id="phonsavanPosts">0</div>
                <div class="text-gray-600">ໃນເມືອງພວນສະຫວັນ</div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="mb-8 bg-white rounded-lg shadow p-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800 mb-4 md:mb-0">ຮູບພາບທັງໝົດ</h2>
                
                <div class="flex space-x-2">
                    <button id="filterAll" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-medium">ທັງໝົດ</button>
                    <button id="filterVientiane" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-300">ນະຄອນຫຼວງ</button>
                    <button id="filterPhonsavan" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-300">ເມືອງພວນສະຫວັນ</button>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="flex justify-center items-center py-12">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
            <span class="ml-3 text-gray-600">ກຳລັງໂຫຼດຂໍ້ມູນ...</span>
        </div>

        <!-- Posts Grid -->
        <div id="postsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Posts will be loaded here -->
        </div>

        <!-- Load More Button -->
        <div id="loadMoreContainer" class="mt-12 text-center hidden">
            <button id="loadMoreBtn" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700 transition flex items-center mx-auto">
                <i class="fas fa-plus mr-2"></i> ໂຫຼດເພີ່ມເຕີມ
            </button>
        </div>

        <!-- No Results Message -->
        <div id="noResults" class="hidden text-center py-12">
            <i class="fas fa-images text-5xl text-gray-300 mb-4"></i>
            <h3 class="text-xl text-gray-600">ບໍ່ມີຂໍ້ມູນ</h3>
            <p class="text-gray-500">ບໍ່ພົບຂໍ້ມູນທີ່ກຳນົດໄວ້</p>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <div class="flex items-center">
                        <img src="https://duabhmoobtojsiab.com/logoxs.png" alt="Duab Toj Siab Logo" class="h-8 w-8 mr-2">
                        <span class="text-xl font-bold">Duab Toj Siab</span>
                    </div>
                    <p class="text-gray-400 mt-2">ຮູບພາບຊາວເມືອງລາວ</p>
                </div>
                
                <div class="text-center md:text-right">
                    <p class="text-gray-400">© 2025 Duab Toj Siab. ສະຫງວນລິຂະສິດ.</p>
                    <p class="text-gray-400 mt-1">ຂໍ້ມູນຈາກ API: apiv2.duabhmoobtojsiab.com</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Image Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="max-w-4xl w-full mx-4 bg-white rounded-lg overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold">ຮູບພາບ</h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 flex justify-center">
                <img id="modalImage" src="" alt="" class="max-h-96 rounded">
            </div>
            <div class="p-4 border-t text-center">
                <p id="modalDescription" class="text-gray-700"></p>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = "https://apiv2.duabhmoobtojsiab.com/page";
        const IMAGE_BASE_URL = "https://filesduab.tojsiab.com/square/450/";

        // DOM Elements
        const postsContainer = document.getElementById('postsContainer');
        const loadingIndicator = document.getElementById('loading');
        const noResultsMessage = document.getElementById('noResults');
        const loadMoreContainer = document.getElementById('loadMoreContainer');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const modalDescription = document.getElementById('modalDescription');
        const closeModal = document.getElementById('closeModal');
        
        // Stats elements
        const totalPostsEl = document.getElementById('totalPosts');
        const totalViewsEl = document.getElementById('totalViews');
        const vientianePostsEl = document.getElementById('vientianePosts');
        const phonsavanPostsEl = document.getElementById('phonsavanPosts');
        
        // Filter buttons
        const filterAll = document.getElementById('filterAll');
        const filterVientiane = document.getElementById('filterVientiane');
        const filterPhonsavan = document.getElementById('filterPhonsavan');
        
        // Global data storage
        let allPosts = [];
        let filteredPosts = [];
        let activeFilter = 'all';
        let currentPage = 0;
        let isLoading = false;

        // Format date function
        function formatDate(dateString) {
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return new Date(dateString).toLocaleDateString('lo-LA', options);
        }

        // Get image URL from API response
        function getImageUrl(imagePath) {
            if (!imagePath) return null;
            
            // Extract the filename from the path
            const filename = imagePath.split('/').pop();
            
            // Remove the file extension
            const nameWithoutExt = filename.split('.')[0];
            
            // Construct the URL as shown in your example
            return `${IMAGE_BASE_URL}${nameWithoutExt}.jpg`;
        }

        // Fetch data from API
        async function fetchData(page = 0, append = false) {
            if (isLoading) return;
            
            try {
                isLoading = true;
                showLoading();
                
                const response = await fetch(`${API_BASE_URL}/${page}/0`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const newPosts = data.items || [];
                
                if (append) {
                    // Append new posts to existing ones
                    allPosts = [...allPosts, ...newPosts];
                } else {
                    // Replace posts with new ones
                    allPosts = newPosts;
                    currentPage = 0;
                }
                
                // Apply current filter
                applyFilter(activeFilter);
                
                // Update stats
                updateStats();
                
                // Show/hide load more button
                if (newPosts.length > 0) {
                    loadMoreContainer.classList.remove('hidden');
                    currentPage = page;
                } else {
                    loadMoreContainer.classList.add('hidden');
                }
                
                hideLoading();
                isLoading = false;
                
            } catch (error) {
                console.error('Error fetching data:', error);
                hideLoading();
                showError('ບໍ່ສາມາດໂຫຼດຂໍ້ມູນໄດ້. ກະລຸນາລອງໃໝ່ພາຍຫຼັງ.');
                isLoading = false;
            }
        }

        // Load more data
        function loadMore() {
            fetchData(currentPage + 1, true);
        }

        // Show loading indicator
        function showLoading() {
            loadingIndicator.classList.remove('hidden');
            if (currentPage === 0) {
                postsContainer.innerHTML = '';
            }
            noResultsMessage.classList.add('hidden');
        }

        // Hide loading indicator
        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }

        // Show error message
        function showError(message) {
            postsContainer.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <i class="fas fa-exclamation-triangle text-5xl text-red-400 mb-4"></i>
                    <h3 class="text-xl text-red-600">ຜິດພາດ</h3>
                    <p class="text-gray-600 mt-2">${message}</p>
                </div>
            `;
        }

        // Update statistics
        function updateStats() {
            const totalPosts = allPosts.length;
            const totalViews = allPosts.reduce((sum, post) => sum + post.view, 0);
            const vientianePosts = allPosts.filter(post => post.location.includes('Vientiane')).length;
            const phonsavanPosts = allPosts.filter(post => post.location.includes('Phônsavan')).length;
            
            totalPostsEl.textContent = totalPosts;
            totalViewsEl.textContent = totalViews.toLocaleString();
            vientianePostsEl.textContent = vientianePosts;
            phonsavanPostsEl.textContent = phonsavanPosts;
        }

        // Apply filter to posts
        function applyFilter(filterType) {
            activeFilter = filterType;
            
            // Reset all filter buttons
            filterAll.classList.remove('bg-purple-600', 'text-white');
            filterVientiane.classList.remove('bg-purple-600', 'text-white');
            filterPhonsavan.classList.remove('bg-purple-600', 'text-white');
            
            // Apply active filter style
            if (filterType === 'all') {
                filteredPosts = allPosts;
                filterAll.classList.add('bg-purple-600', 'text-white');
                filterVientiane.classList.add('bg-gray-200', 'text-gray-700');
                filterPhonsavan.classList.add('bg-gray-200', 'text-gray-700');
            } else if (filterType === 'vientiane') {
                filteredPosts = allPosts.filter(post => post.location.includes('Vientiane'));
                filterVientiane.classList.add('bg-purple-600', 'text-white');
                filterAll.classList.add('bg-gray-200', 'text-gray-700');
                filterPhonsavan.classList.add('bg-gray-200', 'text-gray-700');
            } else if (filterType === 'phonsavan') {
                filteredPosts = allPosts.filter(post => post.location.includes('Phônsavan'));
                filterPhonsavan.classList.add('bg-purple-600', 'text-white');
                filterAll.classList.add('bg-gray-200', 'text-gray-700');
                filterVientiane.classList.add('bg-gray-200', 'text-gray-700');
            }
            
            renderPosts();
        }

        // Render posts to the DOM
        function renderPosts() {
            if (filteredPosts.length === 0) {
                noResultsMessage.classList.remove('hidden');
                postsContainer.innerHTML = '';
                return;
            }
            
            noResultsMessage.classList.add('hidden');
            
            postsContainer.innerHTML = filteredPosts.map(post => {
                const imageUrl = post.images && post.images.length > 0 
                    ? getImageUrl(post.images[0])
                    : null;
                
                return `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden card-hover fade-in">
                        <div class="max-h-96 h-96 bg-cover overflow-hidden w-full cursor-pointer image-container ${!imageUrl ? 'image-placeholder' : ''}" 
                             style="${imageUrl ? `background-image: url('${imageUrl}')` : ''}"
                             onclick="openImageModal('${imageUrl || ''}', '${post.description ? post.description.replace(/'/g, "\\'") : ''}')">
                            ${!imageUrl ? `
                                <div class="text-center">
                                    <i class="fas fa-image text-4xl mb-2"></i>
                                    <p>ບໍ່ມີຮູບພາບ</p>
                                </div>
                            ` : ''}
                                 
                            ${post.images && post.images.length > 1 ? `
                                <div class="absolute top-2 right-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-sm">
                                    <i class="fas fa-images mr-1"></i> ${post.images.length}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="p-4">
                            <p class="text-gray-700 mb-3 line-clamp-2">${post.description || 'ບໍ່ມີຄຳອະທິບາຍ'}</p>
                            
                            <div class="flex justify-between items-center text-sm text-gray-500">
                                <div class="flex items-center">
                                    <i class="fas fa-map-marker-alt mr-1"></i>
                                    <span>${post.location || 'ບໍ່ຮູ້ສະຖານທີ່'}</span>
                                </div>
                                
                                <div class="flex items-center">
                                    <i class="fas fa-eye mr-1"></i>
                                    <span>${post.view || 0}</span>
                                </div>
                            </div>
                            
                            <div class="mt-2 text-xs text-gray-400">
                                <i class="far fa-clock mr-1"></i>
                                ${formatDate(post.createDate)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Open image modal
        function openImageModal(imageUrl, description) {
            if (!imageUrl) return;
            
            modalImage.src = imageUrl;
            modalDescription.textContent = description || 'ບໍ່ມີຄຳອະທິບາຍ';
            imageModal.classList.remove('hidden');
        }

        // Close image modal
        function closeImageModal() {
            imageModal.classList.add('hidden');
        }

        // Event Listeners
        refreshBtn.addEventListener('click', () => fetchData(0, false));
        loadMoreBtn.addEventListener('click', loadMore);
        closeModal.addEventListener('click', closeImageModal);
        
        filterAll.addEventListener('click', () => applyFilter('all'));
        filterVientiane.addEventListener('click', () => applyFilter('vientiane'));
        filterPhonsavan.addEventListener('click', () => applyFilter('phonsavan'));
        
        // Close modal when clicking outside the image
        imageModal.addEventListener('click', (e) => {
            if (e.target === imageModal) {
                closeImageModal();
            }
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => fetchData(0, false));
    </script>
</body>
</html>