<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duab Toj Siab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Noto Sans Lao', sans-serif;
            background-color: #f8fafc;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .image-container {
            position: relative;
            overflow: hidden;
            transition: transform 0.5s ease;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .image-container:hover {
            transform: scale(1.02);
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .loader {
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .image-placeholder {
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                    <img src="https://duabhmoobtojsiab.com/logoxs.png" alt="Duab Toj Siab Logo" class="h-12 w-12 mr-3">
                    <div>
                        <h1 class="text-2xl font-bold">Duab Toj Siab</h1>
                        <p class="text-sm opacity-80">ຮູບພາບຊາວເມືອງລາວ</p>
                    </div>
                </div>
                
                <div class="flex space-x-4">
                    <button id="refreshBtn" class="bg-white text-purple-600 px-4 py-2 rounded-lg font-semibold hover:bg-gray-100 transition flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i> ໂຫຼດຂໍ້ມູນໃໝ່
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Stats Section -->
        <div class="mb-8 grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-2xl font-bold text-purple-600" id="totalPosts">0</div>
                <div class="text-gray-600">ຈຳນວນໂພສ</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-2xl font-bold text-blue-600" id="totalViews">0</div>
                <div class="text-gray-600">ຍອດເບິ່ງຮວມ</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-2xl font-bold text-green-600" id="vientianePosts">0</div>
                <div class="text-gray-600">ໃນນະຄອນຫຼວງ</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-2xl font-bold text-orange-600" id="phonsavanPosts">0</div>
                <div class="text-gray-600">ໃນເມືອງພວນສະຫວັນ</div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="mb-8 bg-white rounded-lg shadow p-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800 mb-4 md:mb-0">ຮູບພາບທັງໝົດ</h2>
                
                <div class="flex space-x-2">
                    <button id="filterAll" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-medium">ທັງໝົດ</button>
                    <button id="filterVientiane" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-300">ນະຄອນຫຼວງ</button>
                    <button id="filterPhonsavan" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-300">ເມືອງພວນສະຫວັນ</button>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="flex justify-center items-center py-12">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
            <span class="ml-3 text-gray-600">ກຳລັງໂຫຼດຂໍ້ມູນ...</span>
        </div>

        <!-- Posts Grid -->
        <div id="postsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Posts will be loaded here -->
        </div>

        <!-- Load More Button -->
        <div id="loadMoreContainer" class="mt-12 text-center hidden">
            <button id="loadMoreBtn" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700 transition flex items-center mx-auto">
                <i class="fas fa-plus mr-2"></i> ໂຫຼດເພີ່ມເຕີມ
            </button>
        </div>

        <!-- No Results Message -->
        <div id="noResults" class="hidden text-center py-12">
            <i class="fas fa-images text-5xl text-gray-300 mb-4"></i>
            <h3 class="text-xl text-gray-600">ບໍ່ມີຂໍ້ມູນ</h3>
            <p class="text-gray-500">ບໍ່ພົບຂໍ້ມູນທີ່ກຳນົດໄວ້</p>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <div class="flex items-center">
                        <img src="https://duabhmoobtojsiab.com/logoxs.png" alt="Duab Toj Siab Logo" class="h-8 w-8 mr-2">
                        <span class="text-xl font-bold">Duab Toj Siab</span>
                    </div>
                    <p class="text-gray-400 mt-2">ຮູບພາບຊາວເມືອງລາວ</p>
                </div>
                
                <div class="text-center md:text-right">
                    <p class="text-gray-400">© 2025 Duab Toj Siab. ສະຫງວນລິຂະສິດ.</p>
                    <p class="text-gray-400 mt-1">ຂໍ້ມູນຈາກ API: apiv2.duabhmoobtojsiab.com</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Image Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 hidden">
        <div class="relative w-full h-full flex items-center justify-center">
            <div class="absolute top-4 right-4 z-50">
                <button id="closeModal" class="text-white hover:text-gray-300 bg-black bg-opacity-50 rounded-full p-2">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <div class="absolute bottom-4 left-0 right-0 z-50 bg-black bg-opacity-50 text-white p-4 text-center">
                <p id="modalDescription" class="text-lg"></p>
            </div>
            
            <div class="relative w-full h-full flex items-center justify-center">
                <img id="modalImage" 
                     src="" 
                     alt="" 
                     class="z-40 max-h-screen max-w-screen object-contain overflow-hidden"
                     loading="lazy"
                     decoding="async">
            </div>
            
            <div class="absolute top-4 left-4 z-50">
                <button id="prevImage" class="text-white hover:text-gray-300 bg-black bg-opacity-50 rounded-full p-2 mr-2 hidden">
                    <i class="fas fa-chevron-left text-2xl"></i>
                </button>
                <button id="nextImage" class="text-white hover:text-gray-300 bg-black bg-opacity-50 rounded-full p-2 hidden">
                    <i class="fas fa-chevron-right text-2xl"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = "https://apiv2.duabhmoobtojsiab.com/page";
        const IMAGE_BASE_URL = "https://filesduab.tojsiab.com/square/450/";

        // DOM Elements
        const postsContainer = document.getElementById('postsContainer');
        const loadingIndicator = document.getElementById('loading');
        const noResultsMessage = document.getElementById('noResults');
        const loadMoreContainer = document.getElementById('loadMoreContainer');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const modalDescription = document.getElementById('modalDescription');
        const closeModal = document.getElementById('closeModal');
        
        // Stats elements
        const totalPostsEl = document.getElementById('totalPosts');
        const totalViewsEl = document.getElementById('totalViews');
        const vientianePostsEl = document.getElementById('vientianePosts');
        const phonsavanPostsEl = document.getElementById('phonsavanPosts');
        
        // Filter buttons
        const filterAll = document.getElementById('filterAll');
        const filterVientiane = document.getElementById('filterVientiane');
        const filterPhonsavan = document.getElementById('filterPhonsavan');
        
        // Global data storage
        let allPosts = [];
        let filteredPosts = [];
        let activeFilter = 'all';
        let currentPage = 0;
        let isLoading = false;
        let currentPostIndex = -1;
        let currentImageIndex = 0;
        let hasRenderedInitialPosts = false;

        // Format date function
        function formatDate(dateString) {
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return new Date(dateString).toLocaleDateString('lo-LA', options);
        }

        // Function to open location in Google Maps
        function openLocationInGoogleMaps(location, coordinates) {
            // If we have coordinates, use them for precise location mapping
            if (coordinates && Array.isArray(coordinates) && coordinates.length >= 2) {
                const [longitude, latitude] = coordinates;
                // Check if coordinates are valid numbers
                if (!isNaN(latitude) && !isNaN(longitude)) {
                    // Create Google Maps URL with exact coordinates
                    const googleMapsUrl = `https://www.google.com/maps?q=${latitude},${longitude}`;
                    window.open(googleMapsUrl, '_blank');
                    return;
                }
            }
            
            // Fallback to text-based search if no valid coordinates
            if (!location || location === 'ບໍ່ຮູ້ສະຖານທີ່') return;
            
            // For common locations in Laos, we can provide better search terms
            const locationMapping = {
                'Vientiane': 'Vientiane, Laos',
                'Phônsavan': 'Phonsavan, Laos',
                'Luang Prabang': 'Luang Prabang, Laos',
                'Pakse': 'Pakse, Laos'
            };
            
            // Check if we have a mapped location
            const mappedLocation = locationMapping[location] || location;
            
            // Encode the location for URL
            const encodedLocation = encodeURIComponent(mappedLocation);
            
            // Create Google Maps URL with better search parameters
            const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodedLocation}&query_place_id`;
            
            // Open in new tab
            window.open(googleMapsUrl, '_blank');
        }

        // Get image URL from API response - FIXED VERSION
        function getImageUrl(imagePath) {
            if (!imagePath) return null;
            
            // The image path from API is like: "73f7eb5c4b02625e4cd2a026e832296e/yb5mxt0ze3ja97hfvc4snqdkw.jpg"
            // We need to extract the hash and filename
            const parts = imagePath.split('/');
            if (parts.length < 2) return null;
            
            const hash = parts[0]; // "73f7eb5c4b02625e4cd2a026e832296e"
            const filename = parts[1]; // "yb5mxt0ze3ja97hfvc4snqdkw.jpg"
            
            // Remove file extension from filename to get the image ID
            const imageId = filename.split('.')[0]; // "yb5mxt0ze3ja97hfvc4snqdkw"
            
            // Construct URL like: "https://filesduab.tojsiab.com/square/450/hash/imageId.jpg"
            return `${IMAGE_BASE_URL}${hash}/${imageId}.jpg`;
        }

        // Alternative method - direct URL construction
        function getDirectImageUrl(imagePath) {
            if (!imagePath) return null;
            
            // If the image path already contains the full structure, we can use it directly
            // The API returns: "73f7eb5c4b02625e4cd2a026e832296e/yb5mxt0ze3ja97hfvc4snqdkw.jpg"
            // We need: "https://filesduab.tojsiab.com/square/450/73f7eb5c4b02625e4cd2a026e832296e/yb5mxt0ze3ja97hfvc4snqdkw.jpg"
            return `https://filesduab.tojsiab.com/square/450/${imagePath}`;
        }

        // Fetch data from API
        async function fetchData(page = 0, append = false) {
            if (isLoading) return;
            
            try {
                isLoading = true;
                showLoading();
                
                const response = await fetch(`${API_BASE_URL}/${page}/0`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const newPosts = data.items || [];
                
                if (append) {
                    // Append new posts to existing ones
                    allPosts = [...allPosts, ...newPosts];
                } else {
                    // Replace posts with new ones
                    allPosts = newPosts;
                    currentPage = 0;
                }
                
                // Apply current filter
                applyFilter(activeFilter);
                
                // Update stats
                updateStats();
                
                // Show/hide load more button
                if (newPosts.length > 0) {
                    loadMoreContainer.classList.remove('hidden');
                    currentPage = page;
                } else {
                    loadMoreContainer.classList.add('hidden');
                }
                
                hideLoading();
                isLoading = false;
                
            } catch (error) {
                console.error('Error fetching data:', error);
                hideLoading();
                showError('ບໍ່ສາມາດໂຫຼດຂໍ້ມູນໄດ້. ກະລຸນາລອງໃໝ່ພາຍຫຼັງ.');
                isLoading = false;
            }
        }

        // Load more data
        function loadMore() {
            fetchData(currentPage + 1, true);
        }

        // Show loading indicator
        function showLoading() {
            loadingIndicator.classList.remove('hidden');
            // Only clear posts container when loading initial data (page 0), not when loading more
            if (currentPage === 0) {
                postsContainer.innerHTML = '';
                hasRenderedInitialPosts = false;
            }
            noResultsMessage.classList.add('hidden');
        }

        // Hide loading indicator
        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }

        // Show error message
        function showError(message) {
            postsContainer.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <i class="fas fa-exclamation-triangle text-5xl text-red-400 mb-4"></i>
                    <h3 class="text-xl text-red-600">ຜິດພາດ</h3>
                    <p class="text-gray-600 mt-2">${message}</p>
                </div>
            `;
        }

        // Update statistics
        function updateStats() {
            const totalPosts = allPosts.length;
            const totalViews = allPosts.reduce((sum, post) => sum + post.view, 0);
            const vientianePosts = allPosts.filter(post => post.location.includes('Vientiane')).length;
            const phonsavanPosts = allPosts.filter(post => post.location.includes('Phônsavan')).length;
            
            totalPostsEl.textContent = totalPosts;
            totalViewsEl.textContent = totalViews.toLocaleString();
            vientianePostsEl.textContent = vientianePosts;
            phonsavanPostsEl.textContent = phonsavanPosts;
        }

        // Apply filter to posts
        function applyFilter(filterType) {
            activeFilter = filterType;
            
            // Reset all filter buttons
            filterAll.classList.remove('bg-purple-600', 'text-white');
            filterVientiane.classList.remove('bg-purple-600', 'text-white');
            filterPhonsavan.classList.remove('bg-purple-600', 'text-white');
            
            // Apply active filter style
            if (filterType === 'all') {
                filteredPosts = allPosts;
                filterAll.classList.add('bg-purple-600', 'text-white');
                filterVientiane.classList.add('bg-gray-200', 'text-gray-700');
                filterPhonsavan.classList.add('bg-gray-200', 'text-gray-700');
            } else if (filterType === 'vientiane') {
                filteredPosts = allPosts.filter(post => post.location.includes('Vientiane'));
                filterVientiane.classList.add('bg-purple-600', 'text-white');
                filterAll.classList.add('bg-gray-200', 'text-gray-700');
                filterPhonsavan.classList.add('bg-gray-200', 'text-gray-700');
            } else if (filterType === 'phonsavan') {
                filteredPosts = allPosts.filter(post => post.location.includes('Phônsavan'));
                filterPhonsavan.classList.add('bg-purple-600', 'text-white');
                filterAll.classList.add('bg-gray-200', 'text-gray-700');
                filterVientiane.classList.add('bg-gray-200', 'text-gray-700');
            }
            
            renderPosts();
        }

        // Render posts to the DOM
        function renderPosts() {
            if (filteredPosts.length === 0) {
                noResultsMessage.classList.remove('hidden');
                if (!hasRenderedInitialPosts) {
                    postsContainer.innerHTML = '';
                }
                return;
            }
            
            noResultsMessage.classList.add('hidden');
            
            // If this is the first render or we're refreshing, clear the container
            if (!hasRenderedInitialPosts || currentPage === 0) {
                postsContainer.innerHTML = '';
                hasRenderedInitialPosts = true;
            }
            
            // Create HTML for new posts only
            const newPostsHTML = filteredPosts.slice(postsContainer.children.length).map((post, index) => {
                // Adjust index to match the global filteredPosts array
                const globalIndex = postsContainer.children.length + index;
                
                // Try both methods to get image URL
                const imageUrl = post.images && post.images.length > 0 
                    ? getDirectImageUrl(post.images[0]) // Using direct method first
                    : null;
                
                return `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden card-hover fade-in">
                        <div class="max-h-96 h-96 overflow-hidden w-full cursor-pointer image-container ${!imageUrl ? 'image-placeholder' : ''}" 
                             ${imageUrl ? `style="background-image: url('${imageUrl}')"` : ''}
                             onclick="openImageModal(${globalIndex})">
                            ${!imageUrl ? `
                                <div class="text-center">
                                    <i class="fas fa-image text-4xl mb-2"></i>
                                    <p>ບໍ່ມີຮູບພາບ</p>
                                </div>
                            ` : ''}
                                 
                            ${post.images && post.images.length > 1 ? `
                                <div class="absolute top-2 right-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-sm">
                                    <i class="fas fa-images mr-1"></i> ${post.images.length}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="p-4">
                            <p class="text-gray-700 mb-3 line-clamp-2">${post.description || 'ບໍ່ມີຄຳອະທິບາຍ'}</p>
                            
                            <div class="flex justify-between items-center text-sm text-gray-500">
                                <div class="flex items-center cursor-pointer hover:text-blue-600" onclick="openLocationInGoogleMaps('${post.location ? post.location.replace(/'/g, "\\'") : 'ບໍ່ຮູ້ສະຖານທີ່'}', ${post.geo ? JSON.stringify(post.geo) : 'null'})" title="Click to view on Google Maps">
                                    <i class="fas fa-map-marker-alt mr-1"></i>
                                    <span>${post.location || 'ບໍ່ຮູ້ສະຖານທີ່'}</span>
                                    <i class="fas fa-external-link-alt ml-1 text-xs"></i>
                                </div>
                                
                                <div class="flex items-center">
                                    <i class="fas fa-eye mr-1"></i>
                                    <span>${post.view || 0}</span>
                                </div>
                            </div>
                            
                            <div class="mt-2 text-xs text-gray-400">
                                <i class="far fa-clock mr-1"></i>
                                ${formatDate(post.createDate)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Append new posts to the container
            postsContainer.insertAdjacentHTML('beforeend', newPostsHTML);
        }

        // Open image modal
        function openImageModal(postIndex, imageIndex = 0) {
            if (postIndex < 0 || postIndex >= filteredPosts.length) return;
            
            const post = filteredPosts[postIndex];
            if (!post.images || post.images.length === 0) return;
            
            // Store current indices
            currentPostIndex = postIndex;
            currentImageIndex = imageIndex;
            
            // Get full size image URL
            const imagePath = post.images[imageIndex];
            const fullImageUrl = `https://filesduab.tojsiab.com/full/1080/${imagePath}`;
            
            // Set image source with srcset for responsive images
            const modalImage = document.getElementById('modalImage');
            modalImage.src = fullImageUrl;
            modalImage.srcset = `${fullImageUrl} 1x, ${fullImageUrl} 2x`;
            modalImage.alt = post.description || 'ຮູບພາບ';
            
            // Set description
            const modalDescription = document.getElementById('modalDescription');
            modalDescription.textContent = post.description || 'ບໍ່ມີຄຳອະທິບາຍ';
            
            // Show/hide navigation buttons
            const prevButton = document.getElementById('prevImage');
            const nextButton = document.getElementById('nextImage');
            
            if (post.images.length > 1) {
                prevButton.classList.remove('hidden');
                nextButton.classList.remove('hidden');
            } else {
                prevButton.classList.add('hidden');
                nextButton.classList.add('hidden');
            }
            
            // Show modal
            document.getElementById('imageModal').classList.remove('hidden');
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        // Navigate to next image
        function nextImage() {
            if (currentPostIndex < 0) return;
            
            const post = filteredPosts[currentPostIndex];
            if (!post.images || post.images.length <= 1) return;
            
            currentImageIndex = (currentImageIndex + 1) % post.images.length;
            openImageModal(currentPostIndex, currentImageIndex);
        }

        // Navigate to previous image
        function prevImage() {
            if (currentPostIndex < 0) return;
            
            const post = filteredPosts[currentPostIndex];
            if (!post.images || post.images.length <= 1) return;
            
            currentImageIndex = (currentImageIndex - 1 + post.images.length) % post.images.length;
            openImageModal(currentPostIndex, currentImageIndex);
        }

        // Close image modal
        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
            // Restore body scroll
            document.body.style.overflow = 'auto';
        }

        // Event Listeners
        refreshBtn.addEventListener('click', () => fetchData(0, false));
        loadMoreBtn.addEventListener('click', loadMore);
        closeModal.addEventListener('click', closeImageModal);
        document.getElementById('prevImage').addEventListener('click', prevImage);
        document.getElementById('nextImage').addEventListener('click', nextImage);
        
        filterAll.addEventListener('click', () => applyFilter('all'));
        filterVientiane.addEventListener('click', () => applyFilter('vientiane'));
        filterPhonsavan.addEventListener('click', () => applyFilter('phonsavan'));
        
        // Close modal when clicking outside the image
        imageModal.addEventListener('click', (e) => {
            if (e.target === imageModal) {
                closeImageModal();
            }
        });

        // Handle keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('imageModal').classList.contains('hidden')) return;
            
            switch(e.key) {
                case 'Escape':
                    closeImageModal();
                    break;
                case 'ArrowLeft':
                    prevImage();
                    break;
                case 'ArrowRight':
                    nextImage();
                    break;
            }
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => fetchData(0, false));
    </script>
</body>
</html>